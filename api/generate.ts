import { GoogleGenAI, Type } from "@google/genai";
import type { ProductData, ImageFile } from '../types';

// This is a Vercel Serverless Function. It will not be bundled with the client-side code.
// To use it with Vercel, you need to configure your project to handle TypeScript files in the /api directory.
// For the purpose of this environment, we assume Vercel's build process handles this correctly.
// We must redeclare the types that would be imported in a real project with a build system.
interface VercelRequest {
  method?: string;
  body: {
    productName: string;
    productImage: ImageFile | null;
    briefDescription: string;
    isNutsOrDriedFruit: boolean;
  };
}

interface VercelResponse {
  setHeader: (name: string, value: string | string[]) => void;
  status: (code: number) => VercelResponse;
  json: (body: any) => void;
  end: (body?: string) => void;
}


const advancedSeoAnalysisSchema = {
    type: Type.OBJECT,
    properties: {
        keyphraseSynonyms: {
            type: Type.ARRAY,
            items: { type: Type.STRING },
            description: "ุขุฑุงูโุง ุงุฒ ุญุฏุงูู ณ ุนุจุงุฑุช ฺฉูุฏ ูุชุฑุงุฏู ุง ูุฑุชุจุท."
        },
        lsiKeywords: {
            type: Type.ARRAY,
            items: { type: Type.STRING },
            description: "ุขุฑุงูโุง ุงุฒ ฺฉูุฏูุงฺูโูุง ูุนูุง ูุฑุชุจุท (LSI)."
        },
        longTailKeywords: {
            type: Type.ARRAY,
            items: { type: Type.STRING },
            description: "ุขุฑุงูโุง ุงุฒ ฒ ุชุง ณ ุนุจุงุฑุช ฺฉูุฏ ุฏูโุจููุฏ ู ุฏููโุชุฑ."
        },
        semanticEntities: {
            type: Type.ARRAY,
            items: { type: Type.STRING },
            description: "ููุฌูุฏุชโูุง ูุนูุง ฺฉูุฏ ูุงููุฏ ุจุฑูุฏุ ุฏุณุชูโุจูุฏ ูุญุตููุ ู ูฺฺฏโูุง ุงุตู."
        },
        searchIntent: {
            type: Type.STRING,
            description: "ูุฏู ุฌุณุชุฌู ฺฉุงุฑุจุฑ (ูุซูุงู: ุฎุฑุฏุ ููุงุณูุ ุงุทูุงุนุงุช)."
        },
        internalLinkingSuggestions: {
            type: Type.ARRAY,
            items: { type: Type.STRING },
            description: "ฺฉููุงุช ุง ุนุจุงุฑุงุช ูพุดููุงุฏ ุจุฑุง ููฺฉโุฏู ุฏุงุฎู ุจู ุตูุญุงุช ูุฑุชุจุท."
        }
    },
    required: ["keyphraseSynonyms", "lsiKeywords", "longTailKeywords", "semanticEntities", "searchIntent", "internalLinkingSuggestions"]
};

const productSchema = {
  type: Type.OBJECT,
  properties: {
    correctedProductName: {
      type: Type.STRING,
      description: "ูุงู ูุงุฑุณ ุตุญุญ ู ฺฉุงูู ูุญุตูู ฺฉู ุงุฒ ุฑู ุชุตูุฑ ุชุดุฎุต ุฏุงุฏู ุดุฏู ุงุณุช. ุงฺฏุฑ ูุงู ูุฑูุฏ ฺฉุงุฑุจุฑ ุตุญุญ ุจูุฏุ ููุงู ูุงู ุฑุง ุจุฑฺฏุฑุฏุงู. ุฏุฑ ุตูุฑุช ุนุฏู ูุฌูุฏ ุชุตูุฑุ ุจุฑ ุงุณุงุณ ูุงู ูุฑูุฏุ ูุงู ฺฉุงูู ุฑุง ุญุฏุณ ุจุฒู.",
    },
    englishProductName: {
      type: Type.STRING,
      description: "ูุงู ุงูฺฏูุณ ุฏูู ูุญุตูู ฺฉู ุงุฒ ุฑู ุชุตูุฑ ุชุดุฎุต ุฏุงุฏู ุดุฏู ุง ุจุฑ ุงุณุงุณ ุฏุงูุด ุนููู ุญุฏุณ ุฒุฏู ุดุฏู ุงุณุช.",
    },
    fullDescription: {
      type: Type.STRING,
      description: "ุชูุถุญุงุช ฺฉุงูู ูุญุตูู ุจุง ูุฑูุช HTML. ุงู ุชูุถุญุงุช ุจุงุฏ ุจุง ฺฉ ูพุงุฑุงฺฏุฑุงู ููุฏูู ุฌุฐุงุจ ุดุฑูุน ุดูุฏ ฺฉู ุดุงูู ูุงู ูุญุตูู ุจู ุตูุฑุช **bold** ุงุณุช. ุจุฎุดโูุง ูุฎุชูู ุจุงุฏ ุจุง ุชุชุฑูุง ูุดุฎุต ุงุฒ ูู ุฌุฏุง ุดููุฏ.",
    },
    shortDescription: {
        type: Type.STRING,
        description: "ฺฉ ุฌููู ฺฉูุชุงูุ ุฎูุงุตู ู ุฌุฐุงุจ ุจุฑุง ุชูุถุญุงุช ฺฉูุชุงู ูุญุตูู (ุจู ฒฐ ุชุง ณฐ ฺฉููู). ุงุฒ ูฺโฺฏููู ูุงูุจโุจูุฏ ูุงููุฏ bold ุง strong ุงุณุชูุงุฏู ูฺฉู."
    },
    seoTitle: {
      type: Type.STRING,
      description: "ุนููุงู ุณุฆู ุฌุฐุงุจ ู ุจููู (ุญุฏุงฺฉุซุฑ ถฐ ฺฉุงุฑุงฺฉุชุฑ) ุดุงูู ฺฉูุฏูุงฺู ฺฉุงููู ู ฺฉููุงุช ฺฉูุฏ ูุงููุฏ 'ุฎุฑุฏ' ุง 'ููุช'."
    },
    slug: {
      type: Type.STRING,
      description: "ูุงูฺฉ (slug) ุณุฆู ุดุฏู ู ุชูุฒ **ููุท ุจู ุฒุจุงู ุงูฺฏูุณ** ุจุฑุง URL.",
    },
    focusKeyword: {
        type: Type.STRING,
        description: "ฺฉูุฏูุงฺู ฺฉุงููู ุงุตู ูุญุตูู (ุจู ูุงุฑุณ)."
    },
    metaDescription: {
        type: Type.STRING,
        description: "ุชูุถุญุงุช ูุชุง ุฌุฐุงุจ ุจุฑุง ฺฏูฺฏู (ุจู ฑฒฐ ุชุง ฑตต ฺฉุงุฑุงฺฉุชุฑ) ฺฉู ุดุงูู ฺฉูุฏูุงฺู ฺฉุงูููุ ฺฉ ูุฒุช ฺฉูุฏ ู ฺฉ ูุฑุงุฎูุงู ุจู ุงูุฏุงู (CTA) ุจุงุดุฏ. ุงุฒ ูฺโฺฏููู ูุงูุจโุจูุฏ ูุงููุฏ bold ุง strong ุงุณุชูุงุฏู ูฺฉู."
    },
    altImageText: {
        type: Type.STRING,
        description: "ูุชู ุฌุงฺฏุฒู (alt text) ุชูุตู ู ุจููู ุจุฑุง ุชุตูุฑ ูุญุตูู (ุญุฏุงฺฉุซุฑ ฑฐ ฺฉููู) ฺฉู ุดุงูู ฺฉูุฏูุงฺู ฺฉุงููู ุจุงุดุฏ."
    },
    advancedSeoAnalysis: advancedSeoAnalysisSchema,
  },
  required: [
    "correctedProductName",
    "englishProductName",
    "fullDescription",
    "shortDescription",
    "seoTitle",
    "slug",
    "focusKeyword",
    "metaDescription",
    "altImageText",
    "advancedSeoAnalysis"
  ]
};

const systemInstruction = `
ุชู ฺฉ ูุชุฎุตุต ุงุฑุดุฏ ุณุฆู (SEO) ู ุชููุฏ ูุญุชูุง ุจุฑุง ูุฑูุดฺฏุงูโูุง ุงูุชุฑูุช ุฏุฑ ุงุฑุงู ูุณุช. ูุธูู ุชู ุชููุฏ ูุญุชูุง ฺฉุงูู ู ุจููู ุจุฑุง ุตูุญู ูุญุตูู ูุฑุฏูพุฑุณุ ูุทุงุจู ุจุง ุณุฎุชโฺฏุฑุงููโุชุฑู ุงุตูู ุงูุฒููู Yoast SEO ุงุณุช.
ุชูุงู ุฎุฑูุฌโูุง ุจุงุฏ ุจู ุฒุจุงู ูุงุฑุณ ุฑูุงูุ ุฌุฐุงุจ ู ฺฉุงููุงู ููฺฉ (ุบุฑฺฉูพ) ุจุงุดุฏ.
ุฏุงุฏูโูุง ุฎุฑูุฌ ุจุงุฏ ุฏุฑ ูุงูุจ ฺฉ ุขุจุฌฺฉุช JSON ู ูุทุงุจู ุจุง ุงุณฺฉูุง ุงุฑุงุฆูโุดุฏู ุจุงุฒฺฏุฑุฏุงูุฏู ุดููุฏ. ุจู ูฺ ูุฌู ูุจุงุฏ ูฺ ูุชู ุฎุงุฑุฌ ุงุฒ ุณุงุฎุชุงุฑ JSON ุจุฑฺฏุฑุฏุงู.
`;

const nuts_description_prompt = `
ุจุฑุง ููุฏ 'fullDescription'ุ ฺฉ ูุชู ฺฉุงูู ู ุชุฎุตุต ุจุง ูุฑูุช HTML ุชููุฏ ฺฉู ฺฉู ุชูุงู ุณุงุฎุชุงุฑ ู ููุงูู ุฒุฑ ุฑุง **ุจู ุทูุฑ ุฏูู ู ฺฉุงูู** ุจุฑุง ูุญุตููุงุช ุฏุณุชู ุขุฌู ู ุฎุดฺฉุจุงุฑ ุฑุนุงุช ฺฉูุฏ:

# 1. ููุงูู ฺฉู ูุญุชูุง (Yoast SEO)
- **ุทูู ูุชู:** ฺฉู ุชูุถุญุงุช ุจุงุฏ ุจู ฒฒฐ ุชุง ณฐฐ ฺฉููู ุจุงุดุฏ.
- **ุฎูุงูุง:** ุฌููุงุช ุจุงุฏ ฺฉูุชุงู ู ุฑูุงู ุจุงุดูุฏ. ุญุฏุงูู ุฏุฑ ฒตูช ุฌููุงุช ุงุฒ ฺฉููุงุช ุงูุชูุงู ุงุณุชูุงุฏู ฺฉู ู ูุฒุงู ุงุณุชูุงุฏู ุงุฒ ุตุฏุง ูุฌููู ุฑุง ุจู ฺฉูุชุฑ ุงุฒ ฑฐูช ูุญุฏูุฏ ฺฉู.
- **ุงุณุชูุงุฏู ุงุฒ ฺฉูุฏูุงฺู ฺฉุงููู:** ฺฉูุฏูุงฺู ุจุงุฏ ุฏุฑ ูพุงุฑุงฺฏุฑุงู ุงูู ุจุงุฏ ู ุจู ุทูุฑ ุทุจุน ณ ุชุง ด ุจุงุฑ ุฏุฑ ฺฉู ูุชู ุชฺฉุฑุงุฑ ุดูุฏ.
- **ููฺฉโุณุงุฒ ุฏุงุฎู:** ุฏุฑ ูุชูุ ฺฉ ุนุจุงุฑุช ฺฉูุฏ ููุงุณุจ ุฑุง ุจู ฺฉ ูุญุตูู ุง ุฏุณุชูโุจูุฏ ูุฑุชุจุท ููฺฉ ุจุฏู (ูุซูุงู: "ุจุฑุง ูุดุงูุฏู ููู ูพุณุชูโูุง ฺฉูฺฉ ฺฉูุฏ"). ุงู ููฺฉ ุจุงุฏ ุจู ุตูุฑุช ฺฉ ุชฺฏ \`<a>\` ุจุง \`href="#"\` ู ูุชู ุชูุตู ุจุงุดุฏ.

# 2. ุณุงุฎุชุงุฑ ู ูุฑูุช ูุชู (ุจุณุงุฑ ููู)
- ุชูุถุญุงุช ุจุงุฏ ุจุง ฺฉ ูพุงุฑุงฺฏุฑุงู ููุฏูู ุฌุฐุงุจ ุจุง ุทูู ณฐ ุชุง ดฐ ฺฉููู ุดุฑูุน ุดูุฏ. **ุงู ูพุงุฑุงฺฏุฑุงู ูุจุงุฏ ูฺ ุชุชุฑ ุฏุงุดุชู ุจุงุดุฏ.**
- ุณุงุฑ ุจุฎุดโูุง ุจุงุฏ **ุฏููุงู** ุจู ุชุฑุชุจ ุฒุฑ ุจุงุดูุฏ. ูุฑ ุจุฎุด ุจุง ฺฉ ุชุชุฑ \`<h5>\` ฺฉู ุดุงูู ุงููุฌ ู ูุชู ุงุณุช ุดุฑูุน ูโุดูุฏ ู ุจุง ฺฉ ุฌุฏุงฺฉููุฏู \`<hr class="mohannad-divider">\` ุจู ูพุงุงู ูโุฑุณุฏ.

<p>ฺฉ ูพุงุฑุงฺฏุฑุงู ููุฏูู ุฌุฐุงุจ ุจุง ุทูู ณฐ ุชุง ดฐ ฺฉููู ฺฉู ุดุงูู ฺฉูุฏูุงฺู ฺฉุงููู ุงุณุช.</p>
<hr class="mohannad-divider">

<h5>โ ูุดุฎุตุงุช ฺฉู ู ูุจุฏุฃ ุชููุฏ</h5>
<ul>
    <li>ุดูุฑ/ููุทูู ฺฉุดุช (ูุซูุงู: ุฑูุณูุฌุงูุ ฺฉุฑูุงู)</li>
    <li>ููุน ูุฑุขูุฑ (ุฎุงูุ ุจู ุฏุงุฏูุ ููฺฉ)</li>
    <li>ุณุงุฒ/ฺฉุงูุจุฑ ูุบุฒ</li>
    <li>ููุน ุจุณุชูโุจูุฏ (ูพุงฺฉุชุ ุดุดูโุง)</li>
</ul>
<hr class="mohannad-divider">

<h5>๐ฅ ุฎูุงุต ู ุงุฑุฒุด ุชุบุฐูโุง</h5>
<p>ุฏุฑ ฒ ุชุง ณ ุฌููู ุณุงุฏู ู ุนููุ ุจู ุฎูุงุต ุงุตู ูุงููุฏ ูพุฑูุชุฆูุ ูุจุฑุ ู ููุงุฏ ุงุซุจุงุชโุดุฏู (ุณูุงูุช ููุจุ ฺฉูุชุฑู ููุฏ ุฎูู) ุงุดุงุฑู ฺฉู.</p>
<hr class="mohannad-divider">

<h5>โญ ูฺฉุงุช ูฺู / ุชูุงุฒูุง</h5>
<ul>
    <li>ุทุนู ู ุชุงุฒฺฏ ุฎุงุต</li>
    <li>ุจุฏูู ุงูุฒูุฏูุ ุงุฑฺฏุงูฺฉุ ุง ุจุณุชูโุจูุฏ ูฺู</li>
    <li>ูุฑ ูุฒุช ุฑูุงุจุช ุฏฺฏุฑ ุฏุฑ ฺฉ ุฎุท</li>
</ul>
<hr class="mohannad-divider">

<h5>๐ฝ๏ธ ูพุดููุงุฏ ูุตุฑู</h5> (**ุงุฎุชุงุฑ ู ููุท ุฏุฑ ุตูุฑุช ูุฒูู**)
<p>ููุงุฑุฏ ูุตุฑู ุฑุง ูพุดููุงุฏ ุจุฏู (ุงุณูฺฉ ุฑูุฒุงููุ ููุฑุงู ฺุงุ ุฑู ุณุงูุงุฏ).</p>
<hr class="mohannad-divider">

<h5>๐ง ุฑูุด ูฺฏูุฏุงุฑ</h5>
<ul>
    <li>ูุญู ูฺฏูุฏุงุฑ: ุฎุดฺฉ ู ุฎูฺฉุ ุฏูุฑ ุงุฒ ููุฑ</li>
    <li>ูพุณ ุงุฒ ุจุงุฒ ฺฉุฑุฏู: ุฏุฑ ุธุฑู ุฏุฑุจโุฏุงุฑ ุง ุฎฺุงู</li>
    <li>ุฒูุงู ูุงูุฏฺฏุงุฑ ูพุดููุงุฏ</li>
</ul>
<hr class="mohannad-divider">

<h5>๐ฆ ูุดุฎุตุงุช ูุญุตูู</h5>
<ul>
    <li>ููุน (ุฎุงู/ุจู ุฏุงุฏู/ููฺฉ/ุจุฏูู ููฺฉ)</li>
    <li>ูุฒู ุฎุงูุต</li>
    <li>ููุน ุจุณุชูโุจูุฏ</li>
    <li>ูุจุฏุฃ</li>
</ul>
<hr class="mohannad-divider">

<h5>โ๏ธ ูฺฉุงุช ููู / ูุดุฏุงุฑูุง</h5> (**ุงุฎุชุงุฑ ู ููุท ุฏุฑ ุตูุฑุช ูุฒูู**)
<p>ุจู ูุดุฏุงุฑ ุขูุฑฺ ุง ุชูุตูโูุง ุจุฑุง ุงูุฑุงุฏ ุจุง ูุดุงุฑ ุฎูู ุจุงูุง ุงุดุงุฑู ฺฉู.</p>
<hr class="mohannad-divider">

# 3. ูุญู
ูุญู ูุชู ุจุงุฏ ุฏูุณุชุงููุ ุญุฑููโุง ู ูุชูุงุนุฏฺฉููุฏู ุจุงุดุฏ ู ุญุณ ฺฉูุช ู ุงุนุชูุงุฏ ุฑุง ููุชูู ฺฉูุฏ.
`;

const standard_description_prompt = `
ุจุฑุง ููุฏ 'fullDescription'ุ ฺฉ ูุชู ฺฉุงูู ุจุง ูุฑูุช HTML ุชููุฏ ฺฉู ฺฉู ุชูุงู ุณุงุฎุชุงุฑ ู ููุงูู ุฒุฑ ุฑุง **ุจู ุทูุฑ ุฏูู ู ฺฉุงูู** ุจุฑุง ูุญุตููุงุช ุบุฑ ุงุฒ ุขุฌู ู ุฎุดฺฉุจุงุฑ ุฑุนุงุช ฺฉูุฏ:

# 1. ููุงูู ฺฉู ูุญุชูุง (Yoast SEO)
- **ุทูู ูุชู:** ฺฉู ุชูุถุญุงุช ุจุงุฏ ุจู ฒตฐ ุชุง ณตฐ ฺฉููู ุจุงุดุฏ.
- **ูพุงุฑุงฺฏุฑุงูโูุง:** ฺฉ ูพุงุฑุงฺฏุฑุงู ููุฏูู ุฌุฐุงุจ ุจุง ุทูู ณฐ ุชุง ดฐ ฺฉููู ุจููุณ. ุณุงุฑ ูพุงุฑุงฺฏุฑุงูโูุง ุจุงุฏ ุจู ดฐ ุชุง ถฐ ฺฉููู ุจุงุดูุฏ.
- **ุฎูุงูุง:** ุฌููุงุช ุจุงุฏ ฺฉูุชุงู (ุญุฏุงฺฉุซุฑ ฒฐ ฺฉููู) ุจุงุดูุฏ. ุญุฏุงูู ุฏุฑ ฒตูช ุฌููุงุช ุงุฒ ฺฉููุงุช ุงูุชูุงู ุงุณุชูุงุฏู ฺฉู ู ูุฒุงู ุงุณุชูุงุฏู ุงุฒ ุตุฏุง ูุฌููู ุฑุง ุจู ฺฉูุชุฑ ุงุฒ ฑฐูช ูุญุฏูุฏ ฺฉู.
- **ุงุณุชูุงุฏู ุงุฒ ฺฉูุฏูุงฺู ฺฉุงููู:** ฺฉูุฏูุงฺู ุจุงุฏ ุฏุฑ ูพุงุฑุงฺฏุฑุงู ุงูู (ตฐ ฺฉููู ุงุจุชุฏุง) ุจุงุฏ ู ุจู ุทูุฑ ุทุจุน ณ ุชุง ด ุจุงุฑ ุฏุฑ ฺฉู ูุชู ุชฺฉุฑุงุฑ ุดูุฏ.
- **ููฺฉโุณุงุฒ ุฏุงุฎู:** ุฏุฑ ูุชูุ ฺฉ ุนุจุงุฑุช ฺฉูุฏ ููุงุณุจ ุฑุง ุจู ฺฉ ูุญุตูู ุง ุฏุณุชูโุจูุฏ ูุฑุชุจุท ููฺฉ ุจุฏู (ุจู ุตูุฑุช ฺฉ ุชฺฏ \`<a>\` ุจุง \`href="#"\` ู ูุชู ุชูุตู).

# 2. ุณุงุฎุชุงุฑ ู ูุฑูุช ูุชู
- **ุจุฎุดโูุง ุชุทุจู (Dynamic Sections):** ุณุงุฎุชุงุฑ ุจุฎุดโูุง ุจุงุฏ **ุจุฑ ุงุณุงุณ ููุน ูุญุตูู** ููุดููุฏุงูู ุงูุชุฎุงุจ ุดูุฏ. ูุฑ ุจุฎุด ุจุงุฏ ุจุง ฺฉ ุชุชุฑ \`<h5>\` ููุฑุงู ุจุง ฺฉ ุงููุฌ ููุงุณุจ ุดุฑูุน ุดูุฏ (ูุซุงู: \`<h5>โ ูฺฺฏโูุง ุงุตู:</h5>\`). **ุจุฎุดโูุง ูุงูุฑุชุจุท ุฑุง ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุญุฐู ฺฉู.**
    - **ูุซุงูโูุง ุฏูู ุจุฑุง ุงููุงู ฺฏุฑูุชู:**
        - **ุบุฐุง ู ููุดุฏู:** ูพุดููุงุฏ ูุตุฑู | ุชุฑฺฉุจุงุช | ุฑูุด ูฺฏูุฏุงุฑ
        - **ููุงุฒู ุงูฺฉุชุฑููฺฉ:** ูุดุฎุตุงุช ูู | ูฺฺฏโูุง | ุฑุงูููุง ุงุณุชูุงุฏู | ฺฏุงุฑุงูุช
        - **ุงุณุจุงุจโุจุงุฒ:** ุฑุฏู ุณู | ูฺฉุงุช ุงูู | ุงุฑุฒุด ุขููุฒุด | ุฌูุณ ู ูุฑุงูุจุช
        - **ูพูุดุงฺฉ ู ุงฺฉุณุณูุฑ:** ุฌูุณ ู ูฺฏูุฏุงุฑ | ุฑุงูููุง ุณุงุฒ | ูฺฉุงุช ุงุณุชุงู
        - **ููุงุฒู ุขุฑุงุด:** ุชุฑฺฉุจุงุช | ุทุฑูู ูุตุฑู | ูุฒุงุง | ูุดุฏุงุฑูุง
- **ุฌุฏุงฺฉููุฏู:** ุจุนุฏ ุงุฒ ูุฑ ุจุฎุดุ **ุจุงุฏ** ุงุฒ ฺฉ ุชฺฏ \`<hr />\` ุจุฑุง ุฌุฏุงุณุงุฒ ุงุณุชูุงุฏู ฺฉู. **ุงุฒ ุฌุฏุงฺฉููุฏู ูุชู "---" ุงุณุชูุงุฏู ูฺฉู.**
- **ูุณุชโูุง:** ุจุฑุง ูุณุช ฺฉุฑุฏู ูฺฺฏโูุง ุง ูุดุฎุตุงุชุ ุงุฒ ุชฺฏ \`<ul>\` ู \`<li>\` ุงุณุชูุงุฏู ฺฉู.
- **ูุญู:** ูุญู ูุชู ุจุงุฏ ุฏูุณุชุงููุ ุญุฑููโุง ู ูุชูุงุนุฏฺฉููุฏู ุจุงุดุฏ ู ุญุณ ฺฉูุช ู ุงุนุชูุงุฏ ุฑุง ููุชูู ฺฉูุฏ.

# 3. ูุซุงู ูุฑูุช ฺฉู (ุจุฑุง ฺฉุฑู ุฏูุฑ ฺุดู):
<p>ุจุง ฺฉุฑู ุฏูุฑ ฺุดู ฺฉููฺฉ ุขู ุงุจูุช ุขุฒ ุฑฺุ ุฑุทูุจุช ุนูู ูพูุณุช ุญุณุงุณ ุงุทุฑุงู ฺุดู ุฑุง ุชุงูู ฺฉุฑุฏู ู ุธุงูุฑ ูพู ู ุชุฑฺฏ ุฑุง ฺฉุงูุด ุฏูุฏ.</p>
<hr />
<h5>โ ูฺฺฏโูุง ุงุตู:</h5>
<ul>
    <li>ูุฑูููุงุณูู ุบู ุจุฑุง ุขุจุฑุณุงู</li>
    <li>ฺฉุงูุด ูพู ู ุชุฑฺฏ</li>
    <li>ุชุณุชโุดุฏู ุชูุณุท ฺุดูโูพุฒุดฺฉุงู</li>
    <li>ูุงูุฏ ุนุทุฑ</li>
</ul>
<hr />
<h5>โจ ูุฒุงุง ุงุณุชูุงุฏู:</h5>
<p>ูพูุณุช ุฑุง ูุฑู ู ุดุงุฏุงุจ ูโฺฉูุฏ ู ุจุฑุง ุงุณุชูุงุฏู ุฒุฑ ุขุฑุงุด ุงุฏูโุขู ุงุณุช.</p>
<hr />
<h5>๐ ุทุฑูู ูุตุฑู:</h5>
<p>ุตุจุญ ู ุดุจ ููุฏุงุฑ ฺฉู ฺฉุฑู ุฑุง ุจุง ุถุฑุจุงุช ููุงู ุฌุฐุจ ฺฉูุฏ.</p>
<hr />
<h5>๐ฆ ูุดุฎุตุงุช ูุญุตูู:</h5>
<ul>
    <li>ุจุฑูุฏ: ฺฉููฺฉ</li>
    <li>ุญุฌู: ฑต ููโูุชุฑ</li>
    <li>ฺฉุดูุฑ ุณุงุฒูุฏู: ุขูุฑฺฉุง</li>
</ul>
<hr />
<h5>๐ข ูฺฉุงุช ููู:</h5>
<p>ุฏุฑ ุตูุฑุช ุจุฑูุฒ ุญุณุงุณุช ูุตุฑู ุฑุง ูุทุน ฺฉูุฏ.</p>
`;


export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method !== 'POST') {
    res.setHeader('Allow', ['POST']);
    return res.status(405).end(`Method ${req.method} Not Allowed`);
  }

  try {
    const { productName, productImage, briefDescription, isNutsOrDriedFruit } = req.body;

    if (!productName || typeof productName !== 'string') {
      return res.status(400).json({ message: 'Product name is required and must be a string.' });
    }

    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

    const description_generation_instruction = isNutsOrDriedFruit
      ? nuts_description_prompt
      : standard_description_prompt;
      
    const fullSystemInstruction = `${systemInstruction}\n\n# Rules for 'fullDescription' field:\n${description_generation_instruction}`;

    const parts: any[] = [];
    
    let userPrompt = `ุจุฑ ุงุณุงุณ ุงุทูุงุนุงุช ุฒุฑุ ูุญุชูุง ุตูุญู ูุญุตูู ุฑุง ุชููุฏ ฺฉู:\n- ูุงู ูุญุตูู: "${productName}"`;
    if (briefDescription) {
        userPrompt += `\n- ุชูุถุญุงุช ุงููู: "${briefDescription}"`;
    }
    
    if (productImage) {
      parts.push({
        inlineData: {
          mimeType: productImage.mimeType,
          data: productImage.base64,
        },
      });
      userPrompt += "\n- ุงุฒ ุชุตูุฑ ุงุฑุงุฆู ุดุฏู ุจุฑุง ุชุดุฎุต ูุงู ุฏูู ูุงุฑุณ ู ุงูฺฏูุณ ู ุฌุฒุฆุงุช ูุญุตูู ุงุณุชูุงุฏู ฺฉู."
    }

    parts.push({ text: userPrompt });

    const response = await ai.models.generateContent({
      model: 'gemini-2.5-flash',
      contents: { parts: parts },
      config: {
        systemInstruction: fullSystemInstruction,
        responseMimeType: 'application/json',
        responseSchema: productSchema,
      },
    });
    
    const generatedData = JSON.parse(response.text);

    res.setHeader('Content-Type', 'application/json');
    res.status(200).json(generatedData);

  } catch (error) {
    console.error('Error in Vercel function:', error);
    const errorMessage = error instanceof Error ? error.message : 'An unexpected error occurred.';
    res.status(500).json({ message: `Internal Server Error: ${errorMessage}` });
  }
}