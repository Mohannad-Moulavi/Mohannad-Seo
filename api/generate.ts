// IMPORTANT: Vercel automatically handles dependencies for serverless functions.
// This function will run in a Node.js environment on the server.

import { GoogleGenAI, Type } from "@google/genai";
import type { ProductData, ImageFile } from '../types';

// This is a Vercel Serverless Function. It will not be bundled with the client-side code.
// To use it with Vercel, you need to configure your project to handle TypeScript files in the /api directory.
// For the purpose of this environment, we assume Vercel's build process handles this correctly.
// We must redeclare the types that would be imported in a real project with a build system.
interface VercelRequest {
  method?: string;
  body: {
    productName: string;
    productImage: ImageFile | null;
    briefDescription: string;
    isNutsOrDriedFruit: boolean;
  };
}

interface VercelResponse {
  setHeader: (name: string, value: string | string[]) => void;
  status: (code: number) => VercelResponse;
  json: (body: any) => void;
  end: (body?: string) => void;
}


const advancedSeoAnalysisSchema = {
    type: Type.OBJECT,
    properties: {
        keyphraseSynonyms: {
            type: Type.ARRAY,
            items: { type: Type.STRING },
            description: "ุขุฑุงูโุง ุงุฒ ุญุฏุงูู ณ ุนุจุงุฑุช ฺฉูุฏ ูุชุฑุงุฏู ุง ูุฑุชุจุท."
        },
        lsiKeywords: {
            type: Type.ARRAY,
            items: { type: Type.STRING },
            description: "ุขุฑุงูโุง ุงุฒ ฺฉูุฏูุงฺูโูุง ูุนูุง ูุฑุชุจุท (LSI)."
        },
        longTailKeywords: {
            type: Type.ARRAY,
            items: { type: Type.STRING },
            description: "ุขุฑุงูโุง ุงุฒ ฒ ุชุง ณ ุนุจุงุฑุช ฺฉูุฏ ุฏูโุจููุฏ ู ุฏููโุชุฑ."
        },
        semanticEntities: {
            type: Type.ARRAY,
            items: { type: Type.STRING },
            description: "ููุฌูุฏุชโูุง ูุนูุง ฺฉูุฏ ูุงููุฏ ุจุฑูุฏุ ุฏุณุชูโุจูุฏ ูุญุตููุ ู ูฺฺฏโูุง ุงุตู."
        },
        searchIntent: {
            type: Type.STRING,
            description: "ูุฏู ุฌุณุชุฌู ฺฉุงุฑุจุฑ (ูุซูุงู: ุฎุฑุฏุ ููุงุณูุ ุงุทูุงุนุงุช)."
        },
        internalLinkingSuggestions: {
            type: Type.ARRAY,
            items: { type: Type.STRING },
            description: "ฺฉููุงุช ุง ุนุจุงุฑุงุช ูพุดููุงุฏ ุจุฑุง ููฺฉโุฏู ุฏุงุฎู ุจู ุตูุญุงุช ูุฑุชุจุท."
        }
    },
    required: ["keyphraseSynonyms", "lsiKeywords", "longTailKeywords", "semanticEntities", "searchIntent", "internalLinkingSuggestions"]
};

const productSchema = {
  type: Type.OBJECT,
  properties: {
    correctedProductName: {
      type: Type.STRING,
      description: "ูุงู ูุงุฑุณ ุตุญุญ ู ฺฉุงูู ูุญุตูู ฺฉู ุงุฒ ุฑู ุชุตูุฑ ุชุดุฎุต ุฏุงุฏู ุดุฏู ุงุณุช. ุงฺฏุฑ ูุงู ูุฑูุฏ ฺฉุงุฑุจุฑ ุตุญุญ ุจูุฏุ ููุงู ูุงู ุฑุง ุจุฑฺฏุฑุฏุงู. ุฏุฑ ุตูุฑุช ุนุฏู ูุฌูุฏ ุชุตูุฑุ ุจุฑ ุงุณุงุณ ูุงู ูุฑูุฏุ ูุงู ฺฉุงูู ุฑุง ุญุฏุณ ุจุฒู.",
    },
    englishProductName: {
      type: Type.STRING,
      description: "ูุงู ุงูฺฏูุณ ุฏูู ูุญุตูู ฺฉู ุงุฒ ุฑู ุชุตูุฑ ุชุดุฎุต ุฏุงุฏู ุดุฏู ุง ุจุฑ ุงุณุงุณ ุฏุงูุด ุนููู ุญุฏุณ ุฒุฏู ุดุฏู ุงุณุช.",
    },
    fullDescription: {
      type: Type.STRING,
      description: "ุชูุถุญุงุช ฺฉุงูู ูุญุตูู ุจุง ูุฑูุช HTML. ุงู ุชูุถุญุงุช ุจุงุฏ ุจุง ฺฉ ูพุงุฑุงฺฏุฑุงู ููุฏูู ุฌุฐุงุจ ุดุฑูุน ุดูุฏ ฺฉู ุดุงูู ูุงู ูุญุตูู ุจู ุตูุฑุช **bold** ุงุณุช. ุจุฎุดโูุง ูุฎุชูู ุจุงุฏ ุจุง ุชุชุฑูุง ูุดุฎุต ุงุฒ ูู ุฌุฏุง ุดููุฏ.",
    },
    shortDescription: {
        type: Type.STRING,
        description: "ฺฉ ุฌููู ฺฉูุชุงูุ ุฎูุงุตู ู ุฌุฐุงุจ ุจุฑุง ุชูุถุญุงุช ฺฉูุชุงู ูุญุตูู (ุจู ฒฐ ุชุง ณฐ ฺฉููู)."
    },
    seoTitle: {
      type: Type.STRING,
      description: "ุนููุงู ุณุฆู ุฌุฐุงุจ ู ุจููู (ุญุฏุงฺฉุซุฑ ถฐ ฺฉุงุฑุงฺฉุชุฑ) ุดุงูู ฺฉูุฏูุงฺู ฺฉุงููู ู ฺฉููุงุช ฺฉูุฏ ูุงููุฏ 'ุฎุฑุฏ' ุง 'ููุช'."
    },
    slug: {
      type: Type.STRING,
      description: "ูุงูฺฉ (slug) ุณุฆู ุดุฏู ู ุชูุฒ **ููุท ุจู ุฒุจุงู ุงูฺฏูุณ** ุจุฑุง URL.",
    },
    focusKeyword: {
        type: Type.STRING,
        description: "ฺฉูุฏูุงฺู ฺฉุงููู ุงุตู ูุญุตูู (ุจู ูุงุฑุณ)."
    },
    metaDescription: {
        type: Type.STRING,
        description: "ุชูุถุญุงุช ูุชุง ุฌุฐุงุจ ุจุฑุง ฺฏูฺฏู (ุจู ฑฒฐ ุชุง ฑตต ฺฉุงุฑุงฺฉุชุฑ) ฺฉู ุดุงูู ฺฉูุฏูุงฺู ฺฉุงูููุ ฺฉ ูุฒุช ฺฉูุฏ ู ฺฉ ูุฑุงุฎูุงู ุจู ุงูุฏุงู (CTA) ุจุงุดุฏ."
    },
    altImageText: {
        type: Type.STRING,
        description: "ูุชู ุฌุงฺฏุฒู (alt text) ุชูุตู ู ุจููู ุจุฑุง ุชุตูุฑ ูุญุตูู (ุญุฏุงฺฉุซุฑ ฑฐ ฺฉููู) ฺฉู ุดุงูู ฺฉูุฏูุงฺู ฺฉุงููู ุจุงุดุฏ."
    },
    advancedSeoAnalysis: advancedSeoAnalysisSchema,
  },
  required: [
    "correctedProductName",
    "englishProductName",
    "fullDescription",
    "shortDescription",
    "seoTitle",
    "slug",
    "focusKeyword",
    "metaDescription",
    "altImageText",
    "advancedSeoAnalysis"
  ]
};

const systemInstruction = `
ุชู ฺฉ ูุชุฎุตุต ุงุฑุดุฏ ุณุฆู (SEO) ู ุชููุฏ ูุญุชูุง ุจุฑุง ูุฑูุดฺฏุงูโูุง ุงูุชุฑูุช ุฏุฑ ุงุฑุงู ูุณุช. ูุธูู ุชู ุชููุฏ ูุญุชูุง ฺฉุงูู ู ุจููู ุจุฑุง ุตูุญู ูุญุตูู ูุฑุฏูพุฑุณุ ูุทุงุจู ุจุง ุณุฎุชโฺฏุฑุงููโุชุฑู ุงุตูู ุงูุฒููู Yoast SEO ุงุณุช.
ุชูุงู ุฎุฑูุฌโูุง ุจุงุฏ ุจู ุฒุจุงู ูุงุฑุณ ุฑูุงูุ ุฌุฐุงุจ ู ฺฉุงููุงู ููฺฉ (ุบุฑฺฉูพ) ุจุงุดุฏ.
ุฏุงุฏูโูุง ุฎุฑูุฌ ุจุงุฏ ุฏุฑ ูุงูุจ ฺฉ ุขุจุฌฺฉุช JSON ู ูุทุงุจู ุจุง ุงุณฺฉูุง ุงุฑุงุฆูโุดุฏู ุจุงุฒฺฏุฑุฏุงูุฏู ุดููุฏ. ุจู ูฺ ูุฌู ูุจุงุฏ ูฺ ูุชู ุฎุงุฑุฌ ุงุฒ ุณุงุฎุชุงุฑ JSON ุจุฑฺฏุฑุฏุงู.
`;

const nuts_description_prompt = `
ุจุฑุง ููุฏ 'fullDescription'ุ ฺฉ ูุชู ฺฉุงูู ู ุชุฎุตุต ุจุง ูุฑูุช HTML ุชููุฏ ฺฉู ฺฉู ุณุงุฎุชุงุฑ ุฒุฑ ุฑุง **ุจู ุทูุฑ ุฏูู ู ฺฉุงูู** ุจุฑุง ูุญุตููุงุช ุฏุณุชู ุขุฌู ู ุฎุดฺฉุจุงุฑ ุฑุนุงุช ฺฉูุฏ:

1.  **ูพุงุฑุงฺฏุฑุงู ููุฏูู:** ฺฉ ูพุงุฑุงฺฏุฑุงู ุฌุฐุงุจ (ฒ ุชุง ณ ุฌููู) ฺฉู ุทุฑุงูุชุ ุทุนูุ ุธุงูุฑ ุง ูฺฺฏ ููุญุตุฑุจูโูุฑุฏ ูุญุตูู ุฑุง ุชูุตู ูโฺฉูุฏ. ูุงู ูุญุตูู ุจุงุฏ ุจู ุตูุฑุช **bold** ุฏุฑ ุงู ูพุงุฑุงฺฏุฑุงู ุจุงุฏ.

2.  **ุจุฎุดโูุง ุชุฎุตุต:** ุดุงูู ุจุฎุดโูุง ุฒุฑ ุจุงุดุฏ ฺฉู ูุฑ ฺฉุฏุงู ุจุง ฺฉ ุชุชุฑ \`<h4>\` ู ฺฉ ุงููุฌ ูุฑุชุจุท ุดุฑูุน ูโุดูุฏ. **ููุท ุจุฎุดโูุง ุฑุง ุงุฌุงุฏ ฺฉู ฺฉู ุจุฑุง ูุญุตูู ููุฑุฏ ูุธุฑ ููุทู ู ูุฑุชุจุท ุจุงุดูุฏ.**
    -   \`<h4>๐ ุฎุงุณุชฺฏุงู ู ูฺฺฏโูุง:</h4>\` (ุจู ููุทูู ฺฉุดุช ูุงููุฏ ุฑูุณูุฌุงู ุง ุฏุงูุบุงูุ ููุน ูุญุตูู (ุฎุงูุ ุดูุฑุ ุจูุฏุงุฏู) ู ุงูุฏุงุฒู ุง ฺฏุฑุฏ ุขู ุงุดุงุฑู ฺฉู.)
    -   \`<h4>๐ช ุงุฑุฒุด ุบุฐุง ู ุฎูุงุต:</h4>\` (ููุงุฏ ูุบุฐ ฺฉูุฏ ูุงููุฏ ูพุฑูุชุฆูุ ูุจุฑุ ูุชุงููโูุง ู ุขูุชโุงฺฉุณุฏุงูโูุง ุฑุง ูุณุช ฺฉู. ุจู ููุงุฏ ุณูุงูุช ูุงููุฏ ุณูุงูุช ููุจุ ฺฏูุงุฑุด ู... ุงุดุงุฑู ฺฉู.)
    -   \`<h4>โจ ูฺฺฏโูุง ููุญุตุฑุจูโูุฑุฏ:</h4>\` (ุฏูุงู ฺฉู ุงู ูุญุตูู ุฑุง ูุชูุงุฒ ูโฺฉูุฏ ุฑุง ุจุงู ฺฉู. ูุซูุงู ุงุฑฺฏุงูฺฉ ุจูุฏูุ ุจุฏูู ุงูุฒูุฏูุ ุณุงุฒ ุงุนูุงุ ุจุณุชูโุจูุฏ ุฎุงุต ุง ฺฏูุงูโูุงููโูุง.)
    -   \`<h4>๐ฝ๏ธ ูพุดููุงุฏ ูุตุฑู:</h4>\` (**ุงุฎุชุงุฑ ู ููุท ุฏุฑ ุตูุฑุช ูุฒูู**) (ูุญูู ูุฐุช ุจุฑุฏู ุงุฒ ูุญุตูู ุฑุง ูพุดููุงุฏ ุจุฏู: ุจู ุนููุงู ูุงูโูุนุฏูุ ุฏุฑ ุณุงูุงุฏุ ุฏุณุฑ ู...)
    -   \`<h4>๐ฆ ุฑูุด ูฺฏูุฏุงุฑ:</h4>\` (ุฏุณุชูุฑุงูุนููโูุง ุฏูู: ุฏุฑ ุฌุง ุฎุดฺฉ ู ุฎูฺฉุ ุฏูุฑ ุงุฒ ููุฑุ ู ูพุณ ุงุฒ ุจุงุฒ ุดุฏู ุฏุฑ ุธุฑู ุฏุฑุจุณุชู ุง ุฎฺุงู.)
    -   \`<h4>๐ ูุดุฎุตุงุช ูุญุตูู:</h4>\` (ูุณุช ุดุงูู ุจุฑูุฏุ ูุฒู ุฎุงูุตุ ููุน (ุฎุงู/ุดูุฑ) ู ููุน ุจุณุชูโุจูุฏ.)
    -   \`<h4>๐ข ูฺฉุงุช ููู:</h4>\` (**ุงุฎุชุงุฑ ู ููุท ุฏุฑ ุตูุฑุช ูุฒูู**) (ูุดุฏุงุฑูุง ุขูุฑฺุ ูฺฉุงุช ุจุฑุง ุงูุฑุงุฏ ุจุง ูุดุงุฑ ุฎูู ุจุงูุง (ุฏุฑ ุตูุฑุช ุดูุฑ ุจูุฏู)ุ ู ููุงุณุจ ุจูุฏู ุจุฑุง ฺฉูุฏฺฉุงู.)

3.  **ุฌุฏุงฺฉููุฏู:** ุจู ูุฑ ุฏู ุจุฎุดุ **ุจุงุฏ** ุงุฒ ฺฉ ุชฺฏ \`<hr />\` ุจุฑุง ุฌุฏุงุณุงุฒ ุงุณุชูุงุฏู ฺฉู.

4.  **ูุณุชโูุง:** ุจุฑุง ุชูุงู ูุณุชโูุง ุงุฒ ุชฺฏ \`<ul>\` ู \`<li>\` ุงุณุชูุงุฏู ฺฉู.

5.  **ููุงุนุฏ Yoast SEO:** ุชูุงู ูุชู ุจุงุฏ ุทุจู ุงุตูู Yoast SEO ููุดุชู ุดูุฏ (ุงุณุชูุงุฏู ุทุจุน ุงุฒ ฺฉูุฏูุงฺูุ ุฎูุงูุง ุจุงูุงุ ูพุงุฑุงฺฏุฑุงูโูุง ฺฉูุชุงูุ ุฌููุงุช ุฑูุงู).

6.  **ูุญู:** ูุญู ูุชู ุจุงุฏ ุฏูุณุชุงููุ ุญุฑููโุง ู ูุชูุงุนุฏฺฉููุฏู ุจุงุดุฏ ู ุญุณ ฺฉูุช ู ุงุนุชูุงุฏ ุฑุง ููุชูู ฺฉูุฏ.
`;

const standard_description_prompt = `
ุจุฑุง ููุฏ 'fullDescription'ุ ฺฉ ูุชู ฺฉุงูู ุจุง ูุฑูุช HTML ุชููุฏ ฺฉู ฺฉู ุชูุงู ุณุงุฎุชุงุฑ ู ููุงูู ุฒุฑ ุฑุง **ุจู ุทูุฑ ุฏูู ู ฺฉุงูู** ุจุฑุง ูุญุตููุงุช ุบุฑ ุงุฒ ุขุฌู ู ุฎุดฺฉุจุงุฑ ุฑุนุงุช ฺฉูุฏ:

# 1. ููุงูู ฺฉู ูุญุชูุง (Yoast SEO)
- **ุทูู ูุชู:** ฺฉู ุชูุถุญุงุช ุจุงุฏ ุจู ฒตฐ ุชุง ณตฐ ฺฉููู ุจุงุดุฏ.
- **ูพุงุฑุงฺฏุฑุงูโูุง:** ฺฉ ูพุงุฑุงฺฏุฑุงู ููุฏูู ุฌุฐุงุจ ุจุง ุทูู ณฐ ุชุง ดฐ ฺฉููู ุจููุณ. ุณุงุฑ ูพุงุฑุงฺฏุฑุงูโูุง ุจุงุฏ ุจู ดฐ ุชุง ถฐ ฺฉููู ุจุงุดูุฏ.
- **ุฎูุงูุง:** ุฌููุงุช ุจุงุฏ ฺฉูุชุงู (ุญุฏุงฺฉุซุฑ ฒฐ ฺฉููู) ุจุงุดูุฏ. ุญุฏุงูู ุฏุฑ ฒตูช ุฌููุงุช ุงุฒ ฺฉููุงุช ุงูุชูุงู ุงุณุชูุงุฏู ฺฉู ู ูุฒุงู ุงุณุชูุงุฏู ุงุฒ ุตุฏุง ูุฌููู ุฑุง ุจู ฺฉูุชุฑ ุงุฒ ฑฐูช ูุญุฏูุฏ ฺฉู.
- **ุงุณุชูุงุฏู ุงุฒ ฺฉูุฏูุงฺู ฺฉุงููู:** ฺฉูุฏูุงฺู ุจุงุฏ ุฏุฑ ูพุงุฑุงฺฏุฑุงู ุงูู (ตฐ ฺฉููู ุงุจุชุฏุง) ุจุงุฏ ู ุจู ุทูุฑ ุทุจุน ณ ุชุง ด ุจุงุฑ ุฏุฑ ฺฉู ูุชู ุชฺฉุฑุงุฑ ุดูุฏ.
- **ููฺฉโุณุงุฒ ุฏุงุฎู:** ุฏุฑ ูุชูุ ฺฉ ุนุจุงุฑุช ฺฉูุฏ ููุงุณุจ ุฑุง ุจู ฺฉ ูุญุตูู ุง ุฏุณุชูโุจูุฏ ูุฑุชุจุท ููฺฉ ุจุฏู (ุจู ุตูุฑุช ฺฉ ุชฺฏ \`<a>\` ุจุง \`href="#"\` ู ูุชู ุชูุตู).

# 2. ุณุงุฎุชุงุฑ ู ูุฑูุช ูุชู
- **ุจุฎุดโูุง ุชุทุจู (Dynamic Sections):** ุณุงุฎุชุงุฑ ุจุฎุดโูุง ุจุงุฏ **ุจุฑ ุงุณุงุณ ููุน ูุญุตูู** ููุดููุฏุงูู ุงูุชุฎุงุจ ุดูุฏ. ูุฑ ุจุฎุด ุจุงุฏ ุจุง ฺฉ ุชุชุฑ **bold** ุดุฏู ููุฑุงู ุจุง ฺฉ ุงููุฌ ููุงุณุจ ุดุฑูุน ุดูุฏ (ูุซุงู: \`<p><strong>โ ูฺฺฏโูุง ุงุตู:</strong></p>\`). ุงุฒ ุชฺฏโูุง ูุฏุฑ (h1-h6) ุงุณุชูุงุฏู ูฺฉู. **ุจุฎุดโูุง ูุงูุฑุชุจุท ุฑุง ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุญุฐู ฺฉู.**
    - **ูุซุงูโูุง ุฏูู ุจุฑุง ุงููุงู ฺฏุฑูุชู:**
        - **ุบุฐุง ู ููุดุฏู:** ูพุดููุงุฏ ูุตุฑู | ุชุฑฺฉุจุงุช | ุฑูุด ูฺฏูุฏุงุฑ
        - **ููุงุฒู ุงูฺฉุชุฑููฺฉ:** ูุดุฎุตุงุช ูู | ูฺฺฏโูุง | ุฑุงูููุง ุงุณุชูุงุฏู | ฺฏุงุฑุงูุช
        - **ุงุณุจุงุจโุจุงุฒ:** ุฑุฏู ุณู | ูฺฉุงุช ุงูู | ุงุฑุฒุด ุขููุฒุด | ุฌูุณ ู ูุฑุงูุจุช
        - **ูพูุดุงฺฉ ู ุงฺฉุณุณูุฑ:** ุฌูุณ ู ูฺฏูุฏุงุฑ | ุฑุงูููุง ุณุงุฒ | ูฺฉุงุช ุงุณุชุงู
        - **ููุงุฒู ุขุฑุงุด:** ุชุฑฺฉุจุงุช | ุทุฑูู ูุตุฑู | ูุฒุงุง | ูุดุฏุงุฑูุง
- **ุฌุฏุงฺฉููุฏู:** ุจุนุฏ ุงุฒ ูุฑ ุจุฎุดุ **ุจุงุฏ** ุงุฒ ฺฉ ุชฺฏ \`<hr />\` ุจุฑุง ุฌุฏุงุณุงุฒ ุงุณุชูุงุฏู ฺฉู. **ุงุฒ ุฌุฏุงฺฉููุฏู ูุชู "---" ุงุณุชูุงุฏู ูฺฉู.**
- **ูุณุชโูุง:** ุจุฑุง ูุณุช ฺฉุฑุฏู ูฺฺฏโูุง ุง ูุดุฎุตุงุชุ ุงุฒ ุชฺฏ \`<ul>\` ู \`<li>\` ุงุณุชูุงุฏู ฺฉู.
- **ูุญู:** ูุญู ูุชู ุจุงุฏ ุฏูุณุชุงููุ ุญุฑููโุง ู ูุชูุงุนุฏฺฉููุฏู ุจุงุดุฏ ู ุญุณ ฺฉูุช ู ุงุนุชูุงุฏ ุฑุง ููุชูู ฺฉูุฏ.

# 3. ูุซุงู ูุฑูุช ฺฉู (ุจุฑุง ฺฉุฑู ุฏูุฑ ฺุดู):
<p>ุจุง ฺฉุฑู ุฏูุฑ ฺุดู ฺฉููฺฉ ุขู ุงุจูุช ุขุฒ ุฑฺุ ุฑุทูุจุช ุนูู ูพูุณุช ุญุณุงุณ ุงุทุฑุงู ฺุดู ุฑุง ุชุงูู ฺฉุฑุฏู ู ุธุงูุฑ ูพู ู ุชุฑฺฏ ุฑุง ฺฉุงูุด ุฏูุฏ.</p>
<hr />
<p><strong>โ ูฺฺฏโูุง ุงุตู:</strong></p>
<ul>
    <li>ูุฑูููุงุณูู ุบู ุจุฑุง ุขุจุฑุณุงู</li>
    <li>ฺฉุงูุด ูพู ู ุชุฑฺฏ</li>
    <li>ุชุณุชโุดุฏู ุชูุณุท ฺุดูโูพุฒุดฺฉุงู</li>
    <li>ูุงูุฏ ุนุทุฑ</li>
</ul>
<hr />
<p><strong>โจ ูุฒุงุง ุงุณุชูุงุฏู:</strong></p>
<p>ูพูุณุช ุฑุง ูุฑู ู ุดุงุฏุงุจ ูโฺฉูุฏ ู ุจุฑุง ุงุณุชูุงุฏู ุฒุฑ ุขุฑุงุด ุงุฏูโุขู ุงุณุช.</p>
<hr />
<p><strong>๐ ุทุฑูู ูุตุฑู:</strong></p>
<p>ุตุจุญ ู ุดุจ ููุฏุงุฑ ฺฉู ฺฉุฑู ุฑุง ุจุง ุถุฑุจุงุช ููุงู ุฌุฐุจ ฺฉูุฏ.</p>
<hr />
<p><strong>๐ฆ ูุดุฎุตุงุช ูุญุตูู:</strong></p>
<ul>
    <li>ุจุฑูุฏ: ฺฉููฺฉ</li>
    <li>ุญุฌู: ฑต ููโูุชุฑ</li>
    <li>ฺฉุดูุฑ ุณุงุฒูุฏู: ุขูุฑฺฉุง</li>
</ul>
<hr />
<p><strong>๐ข ูฺฉุงุช ููู:</strong></p>
<p>ุฏุฑ ุตูุฑุช ุจุฑูุฒ ุญุณุงุณุช ูุตุฑู ุฑุง ูุทุน ฺฉูุฏ.</p>
`;


export default async function handler(req: VercelRequest, res: VercelResponse) {
  if (req.method !== 'POST') {
    res.setHeader('Allow', ['POST']);
    return res.status(405).end(`Method ${req.method} Not Allowed`);
  }

  try {
    const { productName, productImage, briefDescription, isNutsOrDriedFruit } = req.body;

    if (!productName || typeof productName !== 'string') {
      return res.status(400).json({ message: 'Product name is required and must be a string.' });
    }

    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

    const description_generation_instruction = isNutsOrDriedFruit
      ? nuts_description_prompt
      : standard_description_prompt;
      
    const fullSystemInstruction = `${systemInstruction}\n\n# Rules for 'fullDescription' field:\n${description_generation_instruction}`;

    const parts: any[] = [];
    
    let userPrompt = `ุจุฑ ุงุณุงุณ ุงุทูุงุนุงุช ุฒุฑุ ูุญุชูุง ุตูุญู ูุญุตูู ุฑุง ุชููุฏ ฺฉู:\n- ูุงู ูุญุตูู: "${productName}"`;
    if (briefDescription) {
        userPrompt += `\n- ุชูุถุญุงุช ุงููู: "${briefDescription}"`;
    }
    
    if (productImage) {
      parts.push({
        inlineData: {
          mimeType: productImage.mimeType,
          data: productImage.base64,
        },
      });
      userPrompt += "\n- ุงุฒ ุชุตูุฑ ุงุฑุงุฆู ุดุฏู ุจุฑุง ุชุดุฎุต ูุงู ุฏูู ูุงุฑุณ ู ุงูฺฏูุณ ู ุฌุฒุฆุงุช ูุญุตูู ุงุณุชูุงุฏู ฺฉู."
    }

    parts.push({ text: userPrompt });

    const response = await ai.models.generateContent({
      model: 'gemini-2.5-flash',
      contents: { parts: parts },
      config: {
        systemInstruction: fullSystemInstruction,
        responseMimeType: 'application/json',
        responseSchema: productSchema,
      },
    });
    
    const generatedData = JSON.parse(response.text);

    res.setHeader('Content-Type', 'application/json');
    res.status(200).json(generatedData);

  } catch (error) {
    console.error('Error in Vercel function:', error);
    const errorMessage = error instanceof Error ? error.message : 'An unexpected error occurred.';
    res.status(500).json({ message: `Internal Server Error: ${errorMessage}` });
  }
}