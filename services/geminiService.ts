import { GoogleGenAI, Type } from "@google/genai";
import type { ProductData, ImageFile } from '../types';

if (!process.env.API_KEY) {
  throw new Error("API_KEY environment variable not set");
}

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

const productSchema = {
  type: Type.OBJECT,
  properties: {
    correctedProductName: {
      type: Type.STRING,
      description: "ูุงู ูุงุฑุณ ุตุญุญ ู ฺฉุงูู ูุญุตูู ฺฉู ุงุฒ ุฑู ุชุตูุฑ ุชุดุฎุต ุฏุงุฏู ุดุฏู ุงุณุช. ุงฺฏุฑ ูุงู ูุฑูุฏ ฺฉุงุฑุจุฑ ุตุญุญ ุจูุฏุ ููุงู ูุงู ุฑุง ุจุฑฺฏุฑุฏุงู. ุฏุฑ ุตูุฑุช ุนุฏู ูุฌูุฏ ุชุตูุฑุ ุจุฑ ุงุณุงุณ ูุงู ูุฑูุฏุ ูุงู ฺฉุงูู ุฑุง ุญุฏุณ ุจุฒู.",
    },
    englishProductName: {
      type: Type.STRING,
      description: "ูุงู ุงูฺฏูุณ ุฏูู ูุญุตูู ฺฉู ุงุฒ ุฑู ุชุตูุฑ ุชุดุฎุต ุฏุงุฏู ุดุฏู ุง ุจุฑ ุงุณุงุณ ุฏุงูุด ุนููู ุญุฏุณ ุฒุฏู ุดุฏู ุงุณุช.",
    },
    seoTitle: {
      type: Type.STRING,
      description: "ุนููุงู ุณุฆู ุฌุฐุงุจ ู ุจููู (ุฒุฑ ถฐ ฺฉุงุฑุงฺฉุชุฑ) ุดุงูู ฺฉูุฏูุงฺู ฺฉุงููู.",
    },
    slug: {
      type: Type.STRING,
      description: "ูุงูฺฉ (slug) ุณุฆู ุดุฏู ู ุชูุฒ ุจู ุฒุจุงู ูุงุฑุณ ุง ุงูฺฏูุณ ุจุฑุง ุขุฏุฑุณ ุตูุญู ูุญุตูู.",
    },
    fullDescription: {
      type: Type.STRING,
      description: "ุชูุถุญุงุช ฺฉุงูู ู ุญุฑููโุง ูุญุตูู ุจุง ูุฑูุช HTML ุฏููุงู ูุทุงุจู ุณุงุฎุชุงุฑ ุฏุฑุฎูุงุณุช ุฏุฑ ูพุฑุงููพุช (ููุฏููุ ูฺฺฏโูุงุ ูุดุฎุตุงุช ู...). ุงู ุชูุถุญุงุช ุจุงุฏ ุจุณุงุฑ ูุฎุชุตุฑ ู ููุฏ ุจุงุดุฏ.",
    },
    shortDescription: {
        type: Type.STRING,
        description: "ุชูุถุญุงุช ฺฉูุชุงู ู ุฌุฐุงุจ ูุญุตูู (ุญุฏุงฺฉุซุฑ ฒฐ ฺฉููู) ุจุฑุง ููุงุด ุฏุฑ ูุณุช ูุญุตููุงุช.",
    },
    focusKeyword: {
      type: Type.STRING,
      description: "ฺฉูุฏูุงฺู ฺฉุงููู ุงุตู (ฑ ุชุง ณ ฺฉููู) ุจุฑุง ุงูุฒููู Yoast SEO.",
    },
    metaDescription: {
      type: Type.STRING,
      description: "ุชูุถุญุงุช ูุชุง ุฌุฐุงุจ ู ุณุฆู ุดุฏู (ุจู ฑดฐ ุชุง ฑตฐ ฺฉุงุฑุงฺฉุชุฑ).",
    },
    keyphraseSynonyms: {
      type: Type.ARRAY,
      items: {
        type: Type.STRING,
      },
      description: "ุขุฑุงูโุง ุงุฒ ณ ุชุง ต ุนุจุงุฑุช ฺฉูุฏ ูุชุฑุงุฏู.",
    },
  },
  required: ["correctedProductName", "englishProductName", "seoTitle", "slug", "fullDescription", "shortDescription", "focusKeyword", "metaDescription", "keyphraseSynonyms"],
};


const createPrompt = (productName: string, hasImage: boolean) => {
    const step1_withImage = `**ูุฑุญูู ฑ: ุชุดุฎุต ู ุงุตูุงุญ ูุงู ูุญุตูู**
ุงุจุชุฏุงุ ุชุตูุฑ ูุญุตูู ู ูุงู ุงุฑุงุฆู ุดุฏู ุชูุณุท ฺฉุงุฑุจุฑ ("${productName}") ุฑุง ุจู ุฏูุช ุจุฑุฑุณ ฺฉูุฏ.
- ุงฺฏุฑ ูุงู ูุฑูุฏ ฺฉุงุฑุจุฑ ุงุดุชุจุงู ุง ูุงูุต ุงุณุช (ูุซูุงู ูุงูุฏ ุจุฑูุฏุ ูุฒู ุง ูุฏู ุฏูู ุงุณุช)ุ ุขู ุฑุง ุจุฑ ุงุณุงุณ ุงุทูุงุนุงุช ุฏูู ุชุตูุฑ ุงุตูุงุญ ฺฉูุฏ.
- ูุงู **ูุงุฑุณ** ุงุตูุงุญ ุดุฏู ุง ุชุฃุฏ ุดุฏู ุฑุง ุฏุฑ ููุฏ \`correctedProductName\` ูุฑุงุฑ ุฏูุฏ.
- ูุงู **ุงูฺฏูุณ** ุฏูู ูุญุตูู ุฑุง ุฏุฑ ููุฏ \`englishProductName\` ูุฑุงุฑ ุฏูุฏ.
- ุชูุงู ูุฑุงุญู ุจุนุฏ ุชููุฏ ูุญุชูุง ุฑุง ุจุฑ ุงุณุงุณ **ูุงู ุตุญุญ ู ุงุตูุงุญ ุดุฏู** ุงูุฌุงู ุฏูุฏ.`;

    const step1_withoutImage = `**ูุฑุญูู ฑ: ุชุญูู ูุงู ูุญุตูู**
ูุงู ูุญุตูู ุงุฑุงุฆู ุดุฏู ุชูุณุท ฺฉุงุฑุจุฑ "${productName}" ุงุณุช. ุชุตูุฑ ุจุฑุง ุชุญูู ูุฌูุฏ ูุฏุงุฑุฏ.
- ุจุฑ ุงุณุงุณ ูุงู ูุฑูุฏ ฺฉุงุฑุจุฑุ ูุงู ฺฉุงูู ู ุตุญุญ ูุญุตูู ุฑุง ุญุฏุณ ุจุฒูุฏ ู ุฏุฑ ููุฏ \`correctedProductName\` ูุฑุงุฑ ุฏูุฏ (ูุซูุงู ุงฺฏุฑ ูุฑูุฏ "ฺฉุงู ูุช" ุจูุฏุ ุดูุง "ูพูุฏุฑ ฺฉุงู ูุช ูุณุชูู" ุฑุง ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ).
- ูุงู **ุงูฺฏูุณ** ูุญุตูู ุฑุง ุจุฑ ุงุณุงุณ ุฏุงูุด ุนููู ุฎูุฏ ุฏุฑ ููุฏ \`englishProductName\` ูุฑุงุฑ ุฏูุฏ.
- ุชูุงู ูุฑุงุญู ุจุนุฏ ุชููุฏ ูุญุชูุง ุฑุง ุจุฑ ุงุณุงุณ **ูุงู ฺฉู ุฏุฑ correctedProductName ูุฑุงุฑ ุฏุงุฏูโุงุฏ** ุงูุฌุงู ุฏูุฏ.`;

    const intro_withImage = `ูุธูู ุดูุง ุชููุฏ ฺฉ ูพฺฉุฌ ฺฉุงูู ูุญุชูุง ุจุฑุง ฺฉ ุตูุญู ูุญุตูู ูุฑุฏูพุฑุณ ุจุฑ ุงุณุงุณ ูุงู ู ุชุตูุฑ ูุญุตูู ุงุณุช.`;
    const intro_withoutImage = `ูุธูู ุดูุง ุชููุฏ ฺฉ ูพฺฉุฌ ฺฉุงูู ูุญุชูุง ุจุฑุง ฺฉ ุตูุญู ูุญุตูู ูุฑุฏูพุฑุณ ููุท ุจุฑ ุงุณุงุณ ูุงู ูุญุตูู ุงุฑุงุฆู ุดุฏู ุงุณุช.`;
    
    const finalInstruction_withImage = `ุงฺฉูููุ ุจุฑ ุงุณุงุณ ูุงู ูุญุตูู "${productName}" ู ุชุตูุฑ ุถููู ุดุฏูุ ูุญุชูุง JSON ฺฉุงูู ุฑุง ุชููุฏ ฺฉูุฏ.`;
    const finalInstruction_withoutImage = `ุงฺฉูููุ ููุท ุจุฑ ุงุณุงุณ ูุงู ูุญุตูู "${productName}"ุ ูุญุชูุง JSON ฺฉุงูู ุฑุง ุชููุฏ ฺฉูุฏ.`;

    return `
ุดูุง ฺฉ ูุชุฎุตุต ุงุฑุดุฏ ุณุฆู ูุฑุฏูพุฑุณ (ูุชุฎุตุต ุฏุฑ Yoast SEO) ู ุชููุฏ ูุญุชูุง ุญุฑููโุง ุจุฑุง ูุญุตููุงุช ุจู ุฒุจุงู ูุงุฑุณ ูุณุชุฏ.
${hasImage ? intro_withImage : intro_withoutImage}

${hasImage ? step1_withImage : step1_withoutImage}

**ูุฑุญูู ฒ: ุชููุฏ ูุญุชูุง ุจุฑ ุงุณุงุณ ุณุงุฎุชุงุฑ ู ุงุตูู ูุดุฎุต ุดุฏู**
ุจุง ุงุณุชูุงุฏู ุงุฒ ูุงู ุตุญุญ ูุญุตููุ ูุญุชูุง ุฒุฑ ุฑุง ุชููุฏ ฺฉูุฏ ู ุฏุฑ ฺฉ ุขุจุฌฺฉุช JSON ูุนุชุจุฑ ู ุฏูู ูุทุงุจู ุจุง ุงุณฺฉูุง ุงุฑุงุฆู ุดุฏู ุจุฑฺฏุฑุฏุงูุฏ. ูฺ ูุชู ุฎุงุฑุฌ ุงุฒ ุขุจุฌฺฉุช JSON ูุฑุงุฑ ูุฏูุฏ.

---
**ุณุงุฎุชุงุฑ ุงูุฒุงู ุจุฑุง "ุชูุถุญุงุช ฺฉุงูู" (fullDescription):**
ูุญุชูุง ุงู ููุฏ ุจุงุฏ ฺฉ HTML ุฎุงูุต ู ุขูุงุฏู ุจุฑุง ฺฉูพ ุจุงุดุฏ ู **ุฏููุง** ุงุฒ ุณุงุฎุชุงุฑ ุฒุฑ ูพุฑู ฺฉูุฏ.
**ุจุณุงุฑ ููู: ุชูุงู ุจุฎุดโูุง ุจุงุฏ ุจุณุงุฑ ฺฉูุชุงู ู ูุฎุชุตุฑ ุจุงุดูุฏ.** ุงุฒ ููุดุชู ูุชูโูุง ุทููุงู ู ุบุฑุถุฑูุฑ ุฌุฏุงู ุฎูุฏุฏุงุฑ ฺฉูุฏ. ูุฑ ุจุฎุด ุจุงุฏ ุจุง ฺฉ ุชฺฏ \`<hr />\` ุงุฒ ุจุฎุด ุจุนุฏ ุฌุฏุง ุดูุฏ.

1.  **ูพุงุฑุงฺฏุฑุงู ููุฏูู:**
    *   ุจุงุฏ ุจุง ูุงู ูุญุตูู ุจู ุตูุฑุช **ุจููุฏ** ุดุฑูุน ุดูุฏ (ูุซุงู: \`<strong>ฺฉุฑู ุจุงุฏุงู ุฒูู ูุฑู ุฌู</strong>\`).
    *   ููุท **ฺฉ ูพุงุฑุงฺฏุฑุงู ฺฉูุชุงู** (ุญุฏุงฺฉุซุฑ ฒ ุชุง ณ ุฎุท).
    *   ุจู ุจุงูุช/ุทุนูุ ฺฉูุช ู ููุทู ูุฑูุด ุงุตู ุงุดุงุฑู ฺฉูุฏ.
    *   ุจุนุฏ ุงุฒ ุงู ุจุฎุดุ ฺฉ ุชฺฏ \`<hr />\` ูุฑุงุฑ ุฏูุฏ.

2.  **โ ูฺฺฏโูุง ฺฉูุฏ:**
    *   ุนููุงู ุจู ุตูุฑุช \`<strong>โ ูฺฺฏโูุง ฺฉูุฏ</strong>\`.
    *   ูุณุช ุงุฒ **ุญุฏุงฺฉุซุฑ ฒ ุชุง ณ ููุฑุฏ** ฺฉูุฏ ุจุง ุงููุฌ. ูุฑ ููุฑุฏ ฺฉูุชุงู ู ุฏุฑ ฺฉ ุฎุท ุจุงุดุฏ.
    *   ุจุนุฏ ุงุฒ ุงู ุจุฎุดุ ฺฉ ุชฺฏ \`<hr />\` ูุฑุงุฑ ุฏูุฏ.

3.  **๐ฝ ูพุดููุงุฏ ูุตุฑู (ุฏุฑ ุตูุฑุช ูุฑุชุจุท ุจูุฏู):**
    *   ููุท ุงฺฏุฑ ูุญุตูู ุฎูุฑุงฺฉ ุง ูุงุจู ุงุณุชูุงุฏู ุงุณุชุ ุงู ุจุฎุด ุฑุง ุงุถุงูู ฺฉูุฏ.
    *   ุนููุงู ุจู ุตูุฑุช \`<strong>๐ฝ ูพุดููุงุฏ ูุตุฑู</strong>\`.
    *   ูุณุช ุงุฒ **ุญุฏุงฺฉุซุฑ ฒ ูพุดููุงุฏ**.
    *   ุจุนุฏ ุงุฒ ุงู ุจุฎุดุ ฺฉ ุชฺฏ \`<hr />\` ูุฑุงุฑ ุฏูุฏ.

4.  **๐ ุฑูุด ูฺฏูุฏุงุฑ (ุฏุฑ ุตูุฑุช ูุฑุชุจุท ุจูุฏู):**
    *   ุนููุงู ุจู ุตูุฑุช \`<strong>๐ ุฑูุด ูฺฏูุฏุงุฑ</strong>\`.
    *   ูุณุช ุงุฒ **ุญุฏุงฺฉุซุฑ ฒ ูฺฉุชู** ฺฉูุชุงู.
    *   ุจุนุฏ ุงุฒ ุงู ุจุฎุดุ ฺฉ ุชฺฏ \`<hr />\` ูุฑุงุฑ ุฏูุฏ.

5.  **๐ฆ ูุดุฎุตุงุช ูุญุตูู:**
    *   ุนููุงู ุจู ุตูุฑุช \`<strong>๐ฆ ูุดุฎุตุงุช ูุญุตูู</strong>\`.
    *   ูุณุช ุดุงูู **ูููโุชุฑู ูุดุฎุตุงุช** ูุงููุฏ ุจุฑูุฏุ ูุฒูุ ฺฉุดูุฑ ูุจุฏุง.
    *   ุจุนุฏ ุงุฒ ุงู ุจุฎุดุ ฺฉ ุชฺฏ \`<hr />\` ูุฑุงุฑ ุฏูุฏ.

6.  **๐ข ูฺฉุงุช ููู:**
    *   ุนููุงู ุจู ุตูุฑุช \`<strong>๐ข ูฺฉุงุช ููู</strong>\`.
    *   ูุณุช ุงุฒ **ุญุฏุงฺฉุซุฑ ฒ ูฺฉุชู** ููู (ูุงููุฏ ุขูุฑฺูโูุง).
    *   ุจุนุฏ ุงุฒ ุงู ุจุฎุดุ ฺฉ ุชฺฏ \`<hr />\` ูุฑุงุฑ ุฏูุฏ.

---
**ุณุงุฑ ุงูุฒุงูุงุช ูุญุชูุง:**

*   **ุชูุถุญุงุช ฺฉูุชุงู (shortDescription):**
    *   ฺฉ ุฌููู ุฌุฐุงุจ ู ฺฉูุชุงู (ุญุฏุงฺฉุซุฑ ฒฐ ฺฉููู) ฺฉู ูุงูุช ุงุตู ูุญุตูู ุฑุง ุจุงู ูโฺฉูุฏ.

*   **ูุงูฺฉ (slug):**
    *   ฺฉ ูุงูฺฉ ุชูุฒุ ฺฉูุชุงู ู ุณุฆู-ูุญูุฑ ุจู ุฒุจุงู ูุงุฑุณ ุง ุงูฺฏูุณ (ูุซุงู: nestle-coffee-mate-1kg ุง ฺฉุงู-ูุช-ูุณุชูู).

*   **ุนููุงู ุณุฆู (seoTitle):**
    *   ุจุงุฏ ุดุงูู ฺฉูุฏูุงฺู ฺฉุงููู ุจุงุดุฏ.
    *   ุทูู ุขู **ฺฉูุชุฑ ุงุฒ ถฐ ฺฉุงุฑุงฺฉุชุฑ** ุจุงุดุฏ.

*   **ุชูุถุญุงุช ูุชุง (metaDescription):**
    *   ุทูู ุขู ุจู **ฑดฐ ุชุง ฑตฐ ฺฉุงุฑุงฺฉุชุฑ** ุจุงุดุฏ. **ูุฑฺฏุฒ ุงุฒ ฑตฐ ฺฉุงุฑุงฺฉุชุฑ ุจุดุชุฑ ูุดูุฏ.**
    *   ุจุงุฏ ุดุงูู ฺฉูุฏูุงฺู ฺฉุงููู ุจุงุดุฏ.

*   **ฺฉูุฏูุงฺู ฺฉุงููู (focusKeyword):**
    *   ุฏููโุชุฑู ุนุจุงุฑุช ฑ ุชุง ณ ฺฉูููโุง.

*   **ูุชุฑุงุฏูโูุง ฺฉูุฏ (keyphraseSynonyms):**
    *   ูุณุช ุงุฒ ณ ุชุง ต ุนุจุงุฑุช ูุชุฑุงุฏู.

---
**ูุซุงู ุณุงุฎุชุงุฑ ุฎุฑูุฌ ุจุฑุง ูุญุตูู "ฺฉุงู ูุช ูุณุชูู ฑ ฺฉูู":**
{
  "correctedProductName": "ูพูุฏุฑ ฺฉุงู ูุช ูุณุชูู ฑ ฺฉููฺฏุฑู",
  "englishProductName": "Nestle Coffee-Mate 1kg",
  "seoTitle": "ุฎุฑุฏ ฺฉุงู ูุช ูุณุชูู ฑ ฺฉูู | ุจูุชุฑู ููุช",
  "slug": "nestle-coffee-mate-1kg",
  "fullDescription": "<p><strong>ูพูุฏุฑ ฺฉุงูโูุช ูุณุชูู ฑ ฺฉููฺฏุฑู</strong> ุจูุชุฑู ุฌุงฺฏุฒู ุดุฑ ุจุฑุง ูููู ุงุณุช ฺฉู ููุดุฏู ุดูุง ุฑุง ฺฉุฑูุ ูุฑู ู ุฎูุดโุทุนู ูโฺฉูุฏ. ุงู ูุญุตูู ุจุง ูุฑูููุงุณูู ูฺู ุฎูุฏุ ุชุฌุฑุจูโุง ูุฐุชโุจุฎุด ุจุฑุง ุดูุง ูโุณุงุฒุฏ ู ุงูุชุฎุงุจ ุงุฏูโุขู ุจุฑุง ูุตุฑู ุฑูุฒุงูู ุงุณุช.</p><hr /><strong>โ ูฺฺฏโูุง ฺฉูุฏ</strong><ul><li>ุงูุฒูุฏู ุจุงูุช ุฎุงููโุง ู ุบู ุจู ูููู</li><li>ุจุฏูู ูุงฺฉุชูุฒ ู ฺฉูุณุชุฑูู</li><li>ุญูุงูุช ุณุฑุน ู ุขุณุงู ุฏุฑ ููุดุฏู ุฏุงุบ</li></ul><hr /><strong>๐ฝ ูพุดููุงุฏ ูุตุฑู</strong><ul><li>ฺฉ ุชุง ุฏู ูุงุดู ฺุงโุฎูุฑ ุฑุง ุจู ููุฌุงู ูููู ุฏุงุบ ุฎูุฏ ุงุถุงูู ฺฉุฑุฏู ู ูู ุจุฒูุฏ.</li><li>ุจุฑุง ุชูู ุงููุงุน ููุดุฏูโูุง ฺฏุฑู ูุงููุฏ ูุงุช ฺุงฺฉูุช ูุฒ ูุงุจู ุงุณุชูุงุฏู ุงุณุช.</li></ul><hr /><strong>๐ฆ ูุดุฎุตุงุช ูุญุตูู</strong><ul><li>ุจุฑูุฏ: ูุณุชูู (Nestle)</li><li>ูุฒู: ฑ ฺฉููฺฏุฑู</li><li>ฺฉุดูุฑ ูุจุฏุง: ุชุงููุฏ</li></ul><hr /><strong>๐ข ูฺฉุงุช ููู</strong><ul><li>ุงู ูุญุตูู ุฌุงฺฏุฒู ุดุฑ ุฎุดฺฉ ุจุฑุง ููุฒุงุฏุงู ูุณุช.</li></ul><hr />",
  "shortDescription": "ฺฉุงู ูุช ูุณุชููุ ุจูุชุฑู ููุฑุงู ูููู ุจุฑุง ุทุนู ุฎุงููโุง ู ุฏููพุฐุฑ.",
  "focusKeyword": "ฺฉุงู ูุช ูุณุชูู",
  "metaDescription": "ุฎุฑุฏ ูพูุฏุฑ ฺฉุงู ูุช ูุณุชูู ฑ ฺฉููฺฏุฑู ุจุง ุทุนู ุฎุงููโุงุ ุจุฏูู ฺฉูุณุชุฑูู ู ููุงุณุจ ูููู. ุจูุชุฑู ููุช ู ฺฉูุช ุฑุง ุชุฌุฑุจู ฺฉุฑุฏู ู ุงุฒ ููุดุฏู ุฎูุฏ ูุฐุช ุจุจุฑุฏ.",
  "keyphraseSynonyms": ["Coffee Mate", "ูพูุฏุฑ ฺฉุงู ูุช Nestlรฉ", "ุฎุงูู ูููู", "ุฎุฑุฏ ฺฉุงู ูุช"]
}
---

${hasImage ? finalInstruction_withImage : finalInstruction_withoutImage}
`;
}


export const generateProductContent = async (
  productName: string,
  productImage: ImageFile | null
): Promise<ProductData> => {
  try {
    const hasImage = !!productImage;
    const prompt = createPrompt(productName, hasImage);

    const textPart = { text: prompt };
    const parts: any[] = [];

    if (productImage) {
        const imagePart = {
          inlineData: {
            data: productImage.base64,
            mimeType: productImage.mimeType,
          },
        };
        parts.push(imagePart);
    }
    parts.push(textPart);


    const response = await ai.models.generateContent({
      model: 'gemini-2.5-flash',
      contents: { parts: parts },
      config: {
        responseMimeType: "application/json",
        responseSchema: productSchema,
        temperature: 0.7,
      },
    });

    const jsonText = response.text.trim();
    const parsedData = JSON.parse(jsonText);
    
    // Ensure the array is actually an array
    if (!Array.isArray(parsedData.keyphraseSynonyms)) {
        parsedData.keyphraseSynonyms = [];
    }

    return parsedData as ProductData;

  } catch (error) {
    console.error("Error calling Gemini API:", error);
    throw new Error("ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุณ ููุด ูุตููุน. ูุทูุงู ุฏูุจุงุฑู ุชูุงุด ฺฉูุฏ.");
  }
};